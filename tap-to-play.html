<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Music Layer</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #F6F3EA;
    height: 100%;
    overflow: hidden;
    font-family: system-ui, sans-serif;
  }

  /* evita flashes blancos en media */
  audio, video, canvas {
    background: transparent;
  }

  #musicBtn {
    position: fixed;
    bottom: 20px;
    left: 20px;
    padding: 10px 14px;
    border: none;
    border-radius: 999px;
    background: rgba(0,0,0,0.75);
    color: white;
    font-size: 14px;
    cursor: pointer;
  }

  #musicBtn:active {
    transform: scale(0.96);
  }
</style>
</head>

<body>

<button id="musicBtn">music on</button>

<audio id="bgMusic" preload="auto" playsinline loop>
  <source src="music.mp3" type="audio/mpeg">
</audio>

<script>
const audio = document.getElementById("bgMusic");
const btn = document.getElementById("musicBtn");

let playing = false;
let busy = false;

function updateUI() {
  btn.textContent = playing ? "music off" : "music on";
}

async function safePlay() {
  if (busy) return;
  busy = true;

  try {
    audio.load();

    if (audio.readyState < 2) {
      await new Promise(resolve =>
        audio.addEventListener("canplay", resolve, { once: true })
      );
    }

    await audio.play();
    playing = true;

  } catch (e) {
    console.warn("Playback failed:", e);
    playing = false;
  }

  updateUI();
  busy = false;
}

function stop() {
  audio.pause();
  audio.currentTime = 0;
  playing = false;
  updateUI();
}

btn.addEventListener("click", () => {
  playing ? stop() : safePlay();
});

document.addEventListener("visibilitychange", () => {
  if (!document.hidden && playing && audio.paused) {
    playing = false;
    updateUI();
  }
});

updateUI();
</script>

</body>
</html>
